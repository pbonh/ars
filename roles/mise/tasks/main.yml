#SPDX-License-Identifier: MIT-0
---
- name: Mise | Set Role Variables | set_fact
  ansible.builtin.set_fact:
    mise_version_effective: "{{ mise_version | default('v2026.1.6') }}"
    mise_version_no_v: "{{ (mise_version | default('v2026.1.6')) | regex_replace('^v', '') }}"
    mise_install_path_effective: "{{ mise_install_path | default(ansible_env.HOME + '/.local/bin/mise') }}"
    mise_install_from_github_effective: "{{ mise_install_from_github | default(false) | bool }}"
    mise_install_help_effective: "{{ mise_install_help | default(false) | bool }}"
    mise_install_os_override: "{{ mise_install_os | default('') }}"
    mise_install_arch_override: "{{ mise_install_arch | default('') }}"
    mise_install_ext_override: "{{ mise_install_ext | default('') }}"
    mise_install_musl_effective: "{{ mise_install_musl | default(false) | bool }}"
    mise_tarball_url_override: "{{ mise_tarball_url | default('') }}"
    mise_schema_url_effective: "{{ mise_schema_url | default('https://mise.jdx.dev/schema/mise.json') }}"
    mise_task_schema_url_effective: "{{ mise_task_schema_url | default('https://mise.jdx.dev/schema/mise-task.json') }}"
    mise_config_files_effective: "{{ mise_config_files | default([]) }}"
    mise_conf_d_fragments_effective: "{{ mise_conf_d_fragments | default([]) }}"
    mise_env_effective: "{{ mise_env | default({}) }}"
    mise_tools_effective: "{{ mise_tools | default({}) }}"
    mise_tasks_effective: "{{ mise_tasks | default({}) }}"
    mise_settings_effective: "{{ mise_settings | default({}) }}"
    mise_gpg_keys_effective: "{{ mise_gpg_keys | default([]) }}"
    mise_gpg_keyserver_primary_effective: "{{ mise_gpg_keyserver_primary | default('hkps://keyserver.ubuntu.com') }}"
    mise_gpg_keyserver_fallback_effective: "{{ mise_gpg_keyserver_fallback | default('hkps://keys.openpgp.org') }}"
    mise_plugins_effective: "{{ mise_plugins | default({}) }}"
    mise_tool_alias_effective: "{{ mise_tool_alias | default({}) }}"
    mise_shell_alias_effective: "{{ mise_shell_alias | default({}) }}"
    mise_min_version_hard_effective: "{{ mise_min_version_hard | default('') }}"
    mise_min_version_soft_effective: "{{ mise_min_version_soft | default('') }}"
    mise_experimental_monorepo_root_effective: "{{ mise_experimental_monorepo_root | default(false) | bool }}"
    mise_config_raw_effective: "{{ mise_config_raw | default('') }}"

- name: Mise | Normalize tool definitions
  ansible.builtin.set_fact:
    mise_tools_normalized: >-
      {{
        mise_tools_normalized | default({}) | combine({ item.key: {
          'name': (item.value.name if (item.value is mapping and 'name' in item.value) else item.key),
          'version': (
            item.value.version if (item.value is mapping and 'version' in item.value)
            else (item.value if (item.value is string) else 'latest')
          )
        } })
      }}
  loop: "{{ mise_tools_effective | default({}) | dict2items }}"

- name: Mise | Finalize tool facts
  ansible.builtin.set_fact:
    mise_tools_effective: "{{ mise_tools_normalized | default({}) }}"
    mise_tool_names_effective: "{{ mise_tools_normalized | default({}) | dict2items | map(attribute='value') | map(attribute='name') | list }}"

- name: Mise | Default enable_tools when unset
  ansible.builtin.set_fact:
    mise_settings_effective: >-
      {{
        (mise_settings_effective | default({})) |
        combine({
          'enable_tools': (
            mise_settings_effective['enable_tools']
            if (mise_settings_effective is mapping and 'enable_tools' in mise_settings_effective)
            else mise_tool_names_effective
          )
        }, recursive=True)
      }}

- name: Mise | Check for gpg binary
  ansible.builtin.command: gpg --version
  register: mise_gpg_version
  changed_when: false
  failed_when: false
  when:
    - mise_gpg_keys_effective | length > 0
    - mise_settings_effective.gpg_verify | default(false)

- name: Mise | Ensure gpg available when verifying
  ansible.builtin.assert:
    that:
      - mise_gpg_version.rc == 0
    fail_msg: "gpg is required to import mise_gpg_keys; install gpg or disable gpg_verify."
  when:
    - mise_gpg_keys_effective | length > 0
    - mise_settings_effective.gpg_verify | default(false)

- name: Mise | Check for required gpg keys
  ansible.builtin.command: "gpg --list-keys {{ item }}"
  register: mise_gpg_key_check
  changed_when: false
  failed_when: false
  loop: "{{ mise_gpg_keys_effective }}"
  loop_control:
    label: "{{ item }}"
  when:
    - mise_gpg_keys_effective | length > 0
    - mise_gpg_version.rc == 0
    - mise_settings_effective.gpg_verify | default(false)

- name: Mise | Import missing gpg keys (primary)
  ansible.builtin.command: "gpg --batch --keyserver {{ mise_gpg_keyserver_primary_effective }} --recv-keys {{ item.item }}"
  register: mise_gpg_import_primary
  changed_when: false
  failed_when: false
  loop: "{{ (mise_gpg_key_check.results | default([])) | selectattr('rc', 'ne', 0) | list }}"
  loop_control:
    label: "{{ item.item }}"
  when:
    - mise_gpg_keys_effective | length > 0
    - mise_gpg_version.rc == 0
    - mise_gpg_key_check is defined
    - mise_settings_effective.gpg_verify | default(false)

- name: Mise | Import missing gpg keys (fallback)
  ansible.builtin.command: "gpg --batch --keyserver {{ mise_gpg_keyserver_fallback_effective }} --recv-keys {{ item.item }}"
  register: mise_gpg_import_fallback
  changed_when: false
  failed_when: false
  loop: "{{ (mise_gpg_import_primary.results | default([])) | selectattr('rc', 'ne', 0) | list }}"
  loop_control:
    label: "{{ item.item }}"
  when:
    - mise_gpg_keys_effective | length > 0
    - mise_gpg_version.rc == 0
    - mise_gpg_import_primary is defined
    - mise_gpg_keyserver_fallback_effective | length > 0
    - mise_settings_effective.gpg_verify | default(false)

- name: Mise | Verify gpg keys are present
  ansible.builtin.command: "gpg --list-keys {{ item }}"
  register: mise_gpg_key_verify
  changed_when: false
  failed_when: false
  loop: "{{ mise_gpg_keys_effective }}"
  loop_control:
    label: "{{ item }}"
  when:
    - mise_gpg_keys_effective | length > 0
    - mise_gpg_version.rc == 0
    - mise_settings_effective.gpg_verify | default(false)

- name: Mise | Ensure gpg keys imported
  ansible.builtin.assert:
    that:
      - item.rc == 0
    fail_msg: "Failed to import GPG key {{ item.item }} (keyservers: {{ mise_gpg_keyserver_primary_effective }}, {{ mise_gpg_keyserver_fallback_effective }})"
  loop: "{{ mise_gpg_key_verify.results | default([]) }}"
  loop_control:
    label: "{{ item.item }}"
  when:
    - mise_gpg_keys_effective | length > 0
    - mise_gpg_version.rc == 0
    - mise_settings_effective.gpg_verify | default(false)

- name: Mise | Install Mise | import_tasks
  ansible.builtin.import_tasks: install_mise.yml

- name: Mise | Manage Mise Config | include_tasks
  ansible.builtin.include_tasks: manage-config.yml
  when: (mise_config_files_effective | length > 0) or (mise_conf_d_fragments_effective | length > 0)
