---
niri_desktop_shell: "dms"
niri_config_dir: "{{ ansible_env.HOME }}/.config/niri"
niri_config_filename: "local.kdl"
niri_layout_profiles:
  laptop: "default-column-width { proportion 0.75; }"
  ultrawide: "default-column-width { proportion 0.5; }"
niri_preset_column_widths: []
# niri_preset_column_widths:
#   - 0.33333
#   - 0.5
#   - 0.66666
niri_global_layout_options: |
  {% set layout_profile = niri_layout_profiles[display_profile] | default(niri_layout_profiles.laptop) %}
  layout {
    center-focused-column "on-overflow"
    always-center-single-column
  {% if layout_profile | trim | length > 0 %}
    {{ layout_profile | trim | indent(4, true) }}
  {% endif %}
  {% if niri_preset_column_widths | length > 0 %}
    preset-column-widths {
  {% for width in niri_preset_column_widths %}
      proportion {{ width }}
  {% endfor %}
    }
  {% endif %}
  }
# Named workspaces for niri, keyed by lowercase, hyphen-friendly identifiers.
# Each entry supports:
# - name: Display label (defaults to key)
# - open_on_output: Optional monitor identifier
# - layout: Optional per-workspace layout overrides (raw KDL snippet)
niri_named_workspaces:
  browse:
    name: "browse"
  obsidian:
    name: "obsidian"
  code:
    name: "code"
  calc:
    name: "calc"
  vault:
    name: "vault"
  office:
    name: "office"
  media:
    name: "media"
  # system:
  #   name: "system"
# Window rules to place apps onto named workspaces.
# Keys are identifiers; values support:
# - workspace: target workspace key (required)
# - app_id: regex string used in match app-id
# - at_startup: match at-startup=true when true (default: false)
# - extra_match: optional extra match tokens (raw string, e.g., "wm-class=... ")
niri_window_rules:
  brave:
    workspace: "browse"
    app_id: '^Brave-Web-Browser$'
  opera:
    workspace: "browse"
    app_id: '^Opera$'
  thunderbird:
    workspace: "browse"
    app_id: '^org\.mozilla\.Thunderbird$'
  obsidian:
    workspace: "obsidian"
    app_id: '^obsidian$'
  libreoffice:
    workspace: "office"
    app_id: '^libreoffice-startcenter$'
  onlyoffice:
    workspace: "office"
    app_id: '^ONLYOFFICE$'
  boxbuddy:
    workspace: "code"
    app_id: '^io\.github\.dvlv\.boxbuddyrs$'
  ptyxis:
    workspace: "code"
    app_id: '^app\.devsuite\.Ptyxis$'
  ghostty:
    workspace: "code"
    app_id: '^com\.mitchellh\.ghostty$'
  cursor:
    workspace: "code"
    app_id: '^Cursor$'
  zed:
    workspace: "code"
    app_id: '^Zed$'
  konsole:
    workspace: "code"
    app_id: '^org\.kde\.konsole$'
  kalgebra:
    workspace: "calc"
    app_id: '^org\.kde\.kalgebra$'
  cantor:
    workspace: "calc"
    app_id: '^org\.kde\.cantor$'
    open_floating: true
    default_column_width: 1920
    default_window_height: 1080
  qalculate:
    workspace: "calc"
    app_id: '^io\.github\.Qalculate\!$'
    open_floating: true
    default_column_width: 1920
    default_window_height: 1080
  plasmatube:
    workspace: "media"
    app_id: '^org\.kde\.plasmatube$'
  bitwarden:
    workspace: "vault"
    app_id: '^(Bitwarden|com\.bitwarden\.desktop)$'
  # launch with: alacritty --class dropdown
  dropdown:
    app_id: '^dropdown$'
    open_floating: true
    default_floating_position:
      x: 0
      y: 0
      relative_to: "top"
    default_window_height:
      proportion: 0.5
    default_column_width:
      proportion: 0.8
niri_local_kdl_content: |
  {{ niri_global_layout_options }}

  binds {
    Mod+grave {
      spawn "bash" "-lc" r#"
        set -euo pipefail
        json=$(niri msg -j windows)
        id=$(printf '%s' "$json" | jq -r 'first(.[]? | select((."app-id" // .app_id)=="dropdown")) | .id // ""')
        if [ -z "$id" ]; then
          exec foot --app-id dropdown
        fi

        focused_id=$(niri msg -j focused-window 2>/dev/null | jq -r '.id? // "" | tostring') || focused_id=""
        if [ "$focused_id" = "$id" ]; then
          exec niri msg action close-window --id "$id"
        else
          niri msg action focus-window --id "$id" || niri msg focus-window "$id"
          sleep 0.05
          exec niri msg action focus-window --id "$id" || niri msg focus-window "$id"
        fi
      "#;
    }
  }

  {% for ws in niri_named_workspaces | dict2items %}
  workspace "{{ ws.value.name | default(ws.key) }}" {
  {% if ws.value.open_on_output | default('') | length > 0 %}
    open-on-output "{{ ws.value.open_on_output }}"
  {% endif %}
  {% if ws.value.layout is defined and ws.value.layout | trim | length > 0 %}
    layout {
      {{ ws.value.layout | trim | indent(6, true) }}
    }
  {% endif %}
  }
  {% if not loop.last %}

  {% endif %}
  {% endfor %}

  {% if niri_window_rules | length > 0 %}

  {% for rule in niri_window_rules | dict2items %}
  {% set render_rule =
      (rule.value.workspace is defined and rule.value.workspace | length > 0) or
      (rule.value.app_id is defined and rule.value.app_id | length > 0) or
      (rule.value.match is defined and rule.value.match | length > 0) or
      (rule.value.extra_match is defined and rule.value.extra_match | trim | length > 0)
  %}
  {% if render_rule %}
  {% set match_parts = [] %}
  {% if rule.value.at_startup | default(false) %}{% set _ = match_parts.append('at-startup=true') %}{% endif %}
  {% if rule.value.app_id | default('') | length > 0 %}{% set _ = match_parts.append('app-id=r#"' ~ rule.value.app_id ~ '"#') %}{% endif %}
  {% if rule.value.match is defined and rule.value.match | length > 0 %}
  {% for match_item in rule.value.match | dict2items %}
    {% if match_item.value is boolean %}{% set _ = match_parts.append(match_item.key ~ '=' ~ (match_item.value | lower)) %}{% else %}{% set _ = match_parts.append(match_item.key ~ '=' ~ match_item.value) %}{% endif %}
    {% endfor %}
    {% endif %}
  {% if rule.value.extra_match is defined and rule.value.extra_match | trim | length > 0 %}{% set _ = match_parts.append(rule.value.extra_match | trim) %}{% endif %}
  window-rule {
  {% if match_parts | length > 0 %}
    match {{ match_parts | join(' ') }}
  {% endif %}
  {% if rule.value.workspace is defined and rule.value.workspace | length > 0 %}
    open-on-workspace "{{ rule.value.workspace }}"
  {% endif %}
  {% if rule.value.open_floating | default(false) %}
    open-floating true
  {% endif %}
  {% if rule.value.default_floating_position is defined %}
    default-floating-position x={{ rule.value.default_floating_position.x | default(0) }} y={{ rule.value.default_floating_position.y | default(0) }} relative-to="{{ rule.value.default_floating_position.relative_to | default('top') }}"
  {% endif %}
  {% if rule.value.default_column_width is defined %}
    {% set col_width = rule.value.default_column_width %}
    default-column-width {
    {% if col_width is mapping and col_width.proportion is defined %}
      proportion {{ col_width.proportion }};
    {% elif col_width is mapping and col_width.fixed is defined %}
      fixed {{ col_width.fixed }};
    {% else %}
      fixed {{ col_width }};
    {% endif %}
    }
  {% endif %}
  {% if rule.value.default_window_height is defined %}
    {% set window_height = rule.value.default_window_height %}
    default-window-height {
    {% if window_height is mapping and window_height.proportion is defined %}
      proportion {{ window_height.proportion }};
    {% elif window_height is mapping and window_height.fixed is defined %}
      fixed {{ window_height.fixed }};
    {% else %}
      fixed {{ window_height }};
    {% endif %}
    }
  {% endif %}
  }
  {% if not loop.last %}

  {% endif %}
  {% endif %}

  {% endfor %}
  {% endif %}
