---
- name: Claude | Ensure config directory exists
  ansible.builtin.file:
    path: "{{ claude_config_dir }}"
    state: directory
    mode: "0700"

- name: Claude | Install apiKey helper
  ansible.builtin.template:
    src: "claude/api-key-helper.sh.j2"
    dest: "{{ claude_api_key_helper_path }}"
    mode: "0700"
  no_log: true

- name: Claude | Check settings.json
  ansible.builtin.stat:
    path: "{{ claude_settings_path }}"
  register: claude_settings_stat

- name: Claude | Read settings.json
  ansible.builtin.slurp:
    src: "{{ claude_settings_path }}"
  register: claude_settings_raw
  when: claude_settings_stat.stat.exists
  no_log: true

- name: Claude | Parse settings.json
  ansible.builtin.set_fact:
    claude_settings_existing: "{{ (claude_settings_raw.content | b64decode | from_json) if claude_settings_stat.stat.exists else {} }}"
  no_log: true

- name: Claude | Merge apiKeyHelper setting
  ansible.builtin.set_fact:
    claude_settings_merged: "{{ claude_settings_existing | combine({'apiKeyHelper': claude_api_key_helper_path}, recursive=True) }}"
  no_log: true

- name: Claude | Write settings.json
  ansible.builtin.copy:
    dest: "{{ claude_settings_path }}"
    content: "{{ claude_settings_merged | to_nice_json }}"
    mode: "0600"
  no_log: true

- name: Claude | Ensure skills directory exists
  ansible.builtin.file:
    path: "{{ claude_skills_dir }}"
    state: directory
    mode: "0755"
  when: claude_skills | length > 0

- name: Claude | Create per-skill subdirectories
  ansible.builtin.file:
    path: "{{ claude_skills_dir }}/{{ skill.name }}"
    state: directory
    mode: "0755"
  loop: "{{ claude_skills }}"
  loop_control:
    loop_var: skill

- name: Claude | Template SKILL.md files
  ansible.builtin.template:
    src: "claude/SKILL.md.j2"
    dest: "{{ claude_skills_dir }}/{{ skill.name }}/SKILL.md"
    mode: "0644"
  loop: "{{ claude_skills }}"
  loop_control:
    loop_var: skill

- name: Claude | Ensure agents directory exists
  ansible.builtin.file:
    path: "{{ claude_agents_dir }}"
    state: directory
    mode: "0755"
  when: claude_agents | length > 0

- name: Claude | Template agent files
  ansible.builtin.template:
    src: "claude/agent.md.j2"
    dest: "{{ claude_agents_dir }}/{{ agent.name }}.md"
    mode: "0644"
  loop: "{{ claude_agents }}"
  loop_control:
    loop_var: agent
