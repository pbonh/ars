---
- name: Distrobox | Set VM context | facts
  ansible.builtin.set_fact:
    distrobox_vm_name: "{{ distrobox_vm_item.key }}"
    distrobox_clone_name: "{{ distrobox_vm_item.value.clone | default('') }}"
    distrobox_target_exists: "{{ distrobox_vm_item.key in (distrobox_existing_names | default([])) }}"
    distrobox_target_replace: "{{ (distrobox_vm_item.value.replace | default('false')) | bool }}"
    distrobox_target_start_now: "{{ (distrobox_vm_item.value.start_now | default('false')) | bool }}"

- name: Distrobox | Fail on clone cycles | assert
  ansible.builtin.fail:
    msg: "Distrobox clone cycle detected at '{{ distrobox_vm_name }}'."
  when: distrobox_vm_name in (distrobox_chain | default([]))

- name: Distrobox | Validate clone source | assert
  ansible.builtin.fail:
    msg: "Distrobox clone '{{ distrobox_vm_name }}' references undefined source '{{ distrobox_clone_name }}'."
  when:
    - distrobox_clone_name | length > 0
    - distrobox_clone_name not in distrobox_vms

- name: Distrobox | Set creation flag | facts
  ansible.builtin.set_fact:
    distrobox_target_will_create: "{{ (not distrobox_target_exists) or distrobox_target_replace }}"

- name: Distrobox | Ensure clone source | tasks
  ansible.builtin.include_tasks: ensure.yml
  vars:
    distrobox_vm_item: "{{ {'key': distrobox_clone_name, 'value': distrobox_vms[distrobox_clone_name]} }}"
    distrobox_chain: "{{ (distrobox_chain | default([])) + [distrobox_vm_name] }}"
  when:
    - distrobox_clone_name | length > 0
    - distrobox_target_will_create
    - distrobox_clone_name not in distrobox_processed

- name: Distrobox | Record clone source running state | facts
  ansible.builtin.set_fact:
    distrobox_clone_source_running: "{{ distrobox_clone_name in (distrobox_running_names | default([])) }}"
  when:
    - distrobox_clone_name | length > 0
    - distrobox_target_will_create

- name: Distrobox | Ensure clone source stopped for cloning | command
  ansible.builtin.command: distrobox stop "{{ distrobox_clone_name }}"
  changed_when: true
  failed_when: false
  when:
    - distrobox_clone_name | length > 0
    - distrobox_target_will_create

- name: Distrobox | Remove existing target when replacing | command
  ansible.builtin.command: distrobox rm --force "{{ distrobox_vm_name }}"
  changed_when: true
  when:
    - distrobox_target_replace
    - distrobox_target_exists

- name: Distrobox | Create container from clone | command
  ansible.builtin.command:
    argv: >-
      {{
        ['distrobox', 'create', '--clone', distrobox_clone_name,
         '--name', distrobox_vm_name,
         '--home', distrobox_home ~ '/' ~ distrobox_vm_name]
        + (distrobox_vm_item.value.pull | default('false') | bool | ternary(['--pull'], ['--yes']))
        + (distrobox_vm_item.value.init | default('false') | bool | ternary(['--init'], []))
        + (distrobox_vm_item.value.nvidia | default('false') | bool | ternary(['--nvidia'], []))
        + (distrobox_vm_item.value.root | default('false') | bool | ternary(['--root'], []))
        + (
            (distrobox_vm_item.value.entry is defined
             and (distrobox_vm_item.value.entry | default('false') | bool) == false)
            | ternary(['--no-entry'], [])
          )
        + (
            distrobox_vm_item.value.volume is defined
            | ternary(['--volume', distrobox_vm_item.value.volume], [])
          )
        + (
            distrobox_vm_item.value.additional_packages is defined
            | ternary(['--additional-packages', distrobox_vm_item.value.additional_packages], [])
          )
        + (
            distrobox_vm_item.value.additional_flags is defined
            | ternary(['--additional-flags', distrobox_vm_item.value.additional_flags], [])
          )
        + (
            distrobox_vm_item.value.pre_init_hooks is defined
            | ternary(
                ['--pre-init-hooks',
                 (
                   (distrobox_vm_item.value.pre_init_hooks is sequence
                    and distrobox_vm_item.value.pre_init_hooks is not string)
                   | ternary(
                       (distrobox_vm_item.value.pre_init_hooks | join(' && ')),
                       distrobox_vm_item.value.pre_init_hooks
                     )
                 )
                ],
                []
              )
          )
        + (
            distrobox_vm_item.value.init_hooks is defined
            | ternary(
                ['--init-hooks',
                 (
                   (distrobox_vm_item.value.init_hooks is sequence
                    and distrobox_vm_item.value.init_hooks is not string)
                   | ternary(
                       (distrobox_vm_item.value.init_hooks | join(' && ')),
                       distrobox_vm_item.value.init_hooks
                     )
                 )
                ],
                []
              )
          )
      }}
  changed_when: true
  when:
    - distrobox_target_will_create
    - distrobox_clone_name | length > 0

- name: Distrobox | Create container from image | command
  ansible.builtin.command:
    argv: >-
      {{
        ['distrobox', 'create',
         '--image', distrobox_vm_item.value.image,
         '--name', distrobox_vm_name,
         '--home', distrobox_home ~ '/' ~ distrobox_vm_name]
        + (distrobox_vm_item.value.pull | default('false') | bool | ternary(['--pull'], ['--yes']))
        + (distrobox_vm_item.value.init | default('false') | bool | ternary(['--init'], []))
        + (distrobox_vm_item.value.nvidia | default('false') | bool | ternary(['--nvidia'], []))
        + (distrobox_vm_item.value.root | default('false') | bool | ternary(['--root'], []))
        + (
            (distrobox_vm_item.value.entry is defined
             and (distrobox_vm_item.value.entry | default('false') | bool) == false)
            | ternary(['--no-entry'], [])
          )
        + (
            distrobox_vm_item.value.volume is defined
            | ternary(['--volume', distrobox_vm_item.value.volume], [])
          )
        + (
            distrobox_vm_item.value.additional_packages is defined
            | ternary(
                ['--additional-packages',
                 (distrobox_vm_item.value.additional_packages
                  | regex_replace('^"(.*)"$', '\\1'))
                ],
                []
              )
          )
        + (
            distrobox_vm_item.value.additional_flags is defined
            | ternary(
                ['--additional-flags',
                 (distrobox_vm_item.value.additional_flags
                  | regex_replace('^"(.*)"$', '\\1'))
                ],
                []
              )
          )
        + (
            distrobox_vm_item.value.pre_init_hooks is defined
            | ternary(
                ['--pre-init-hooks',
                 (
                   (distrobox_vm_item.value.pre_init_hooks is sequence
                    and distrobox_vm_item.value.pre_init_hooks is not string)
                   | ternary(
                       (distrobox_vm_item.value.pre_init_hooks | join(' && ')),
                       distrobox_vm_item.value.pre_init_hooks
                     )
                 )
                ],
                []
              )
          )
        + (
            distrobox_vm_item.value.init_hooks is defined
            | ternary(
                ['--init-hooks',
                 (
                   (distrobox_vm_item.value.init_hooks is sequence
                    and distrobox_vm_item.value.init_hooks is not string)
                   | ternary(
                       (distrobox_vm_item.value.init_hooks | join(' && ')),
                       distrobox_vm_item.value.init_hooks
                     )
                 )
                ],
                []
              )
          )
      }}
  changed_when: true
  when:
    - distrobox_target_will_create
    - distrobox_clone_name | length == 0

- name: Distrobox | Restore clone source running state | command
  ansible.builtin.command: distrobox enter --name "{{ distrobox_clone_name }}" -- true
  changed_when: true
  when:
    - distrobox_clone_name | length > 0
    - distrobox_target_will_create
    - distrobox_clone_source_running

- name: Distrobox | Start container after creation | command
  ansible.builtin.command: distrobox enter --name "{{ distrobox_vm_name }}" -- true
  changed_when: true
  when:
    - distrobox_target_will_create
    - distrobox_target_start_now

- name: Distrobox | Mark processed | facts
  ansible.builtin.set_fact:
    distrobox_processed: "{{ distrobox_processed + [distrobox_vm_name] }}"
